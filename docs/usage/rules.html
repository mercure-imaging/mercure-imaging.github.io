<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rules &mdash; mercure Version 0.4.0-beta.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Queue Management" href="queue.html" />
    <link rel="prev" title="Modules" href="modules.html" />
<a href="https://mercure-imaging.zulipchat.com" target="_none" class="chat-button" title="Open mercure online community">Open Chat</a>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/mercure_logo_w.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                Version 0.4.0-beta.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/mercure-imaging/mercure">github.com/mercure-imaging/mercure</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">What is mercure?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="targets.html">Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="modules.html">Modules</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="queue.html">Queue Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="query.html">Query Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#web-interface">Web Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#user-management">User Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#system-status-and-control">System Status and Control</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring.html">Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dashboards.html">Dashboard Gallery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Module Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../module_list.html">Existing Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anonymizer.html">Anonymizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dcmannotate.html">DCMAnnotate</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Discussion Board</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../environment.html">Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source/index.html">Code Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">mercure</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Usage</a></li>
      <li class="breadcrumb-item active">Rules</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rules">
<h1>Rules<a class="headerlink" href="#rules" title="Permalink to this heading"></a></h1>
<p>After you have configured your targets and processing modules, you can define rules that specify which DICOM series should be processed and to which targets the images should be dispatched. This can be done on the “Settings &gt; Rules” page.</p>
<a class="border reference internal image-reference" href="../_images/rules.png"><img alt="../_images/rules.png" class="border align-center" src="../_images/rules.png" style="width: 550px;" /></a>
<p>It is not necessary to stop mercure services while defining new rules. The mercure service modules will automatically reload the new configuration when a rule has been added or modified. Click the “Add” button to create a new rule, or click on any of the existing rules and select “Edit” to modify it.</p>
<section id="filtering-tab">
<h2>Filtering tab<a class="headerlink" href="#filtering-tab" title="Permalink to this heading"></a></h2>
<p>All rules are evaluated whenever a new DICOM series has been received. The rules can use a set of DICOM tags extracted from the incoming DICOM files. To see the full list of DICOM tags available for writing rules, click the “Available Tags” button.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you need additional tags that are currently not in the list, you can enable additional tags in system settings.</p>
</div>
<a class="border reference internal image-reference" href="../_images/edit.png"><img alt="../_images/edit.png" class="border align-center" src="../_images/edit.png" style="width: 550px;" /></a>
<p>A received series will processed if the selection rule evaluates to True, and it will be ignored if the rule evaluates to False. If none of the defined rules evaluates to True, the series will be discarded.</p>
<p>Selection rules are evaluated as Python expressions. Tags are available as properties on an object called “<cite>tags</cite>”, so for instance a rule like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;CINE&#39; in tags.SeriesDescription
</pre></div>
</div>
<p>will activate for all series that have the word “CINE” in the series description (e.g., “CINE 2ch”). If you only want to send series that are exactly called “CINE”, use the following rule instead</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Older versions of Mercure used a syntax like <code class="docutils literal notranslate"><span class="pre">'CINE'</span> <span class="pre">in</span> <span class="pre">%SeriesDescription%</span></code>. This syntax is still valid but should not be used in new rules.</p>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tags.SeriesDescription == &#39;CINE&#39;
</pre></div>
</div>
<p>This rule would not trigger if the series is called “CINE 2ch”. Multiple conditions can be combined using the “or” and “and” operators. Here, it is recommended to enclose every sub-condition with “( )”. By default, DICOM tags are treated as strings and are case-sensitive. If you want to make your condition case-insensitive, then append “.lower()” to the tag.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tags.SeriesDescription.lower() = &#39;cine&#39;
</pre></div>
</div>
<p>This would trigger for series called “CINE” or “cine”. If you want to test for numerical value thresholds (e.g., if the slice thickness is lower than 2mm), you first need to convert the tag into a float by writing the tag inside “<code class="docutils literal notranslate"><span class="pre">float()</span></code>”. This then allows you to write a rule like</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>float(tags.SliceThickness) &lt; 2.0
</pre></div>
</div>
<section id="testing-rules">
<h3>Testing Rules<a class="headerlink" href="#testing-rules" title="Permalink to this heading"></a></h3>
<p>To test a selection rule before activating it, click the icon with the cog wheels on the left side of input box. If you see a red icon in the dialog, the rule notation is invalid (the dialog will tell you why). If the rule is valid, the dialog will test if the rule would trigger if a DICOM series with the values shown in the lower part of the dialog would be received. You can modify these values and test if the rule reacts as expected.</p>
<a class="border reference internal image-reference" href="../_images/test.png"><img alt="../_images/test.png" class="border align-center" src="../_images/test.png" style="width: 550px;" /></a>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If you make a mistake while changing the test values (e.g., missing a quotation mark), you will see a yellow icon.</p>
</div>
</section>
<section id="rule-actions">
<h3>Rule Actions<a class="headerlink" href="#rule-actions" title="Permalink to this heading"></a></h3>
<p>If you have validated that your rule triggers as expected, select the desired Action from the drop-down list. The following options are available:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Action</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Routing</p></td>
<td><p>The received series/study will be dispatched to a target (no processing)</p></td>
</tr>
<tr class="row-odd"><td><p>Processing &amp; Routing</p></td>
<td><p>The received series/study will be processed and afterwards dispatched</p></td>
</tr>
<tr class="row-even"><td><p>Processing only</p></td>
<td><p>The received series/study will be processed (without further dispatching)</p></td>
</tr>
<tr class="row-odd"><td><p>Notification only</p></td>
<td><p>A notification will be triggered if the series/study is received (without neither processing or dispatching)</p></td>
</tr>
<tr class="row-even"><td><p>Force discard</p></td>
<td><p>The received series/study will be discarded (no other rules will be evaluated)</p></td>
</tr>
</tbody>
</table>
<p>Depending on the selected Action, the tabs “Processing” and “Routing” will become visible.</p>
</section>
<section id="rule-triggers">
<h3>Rule Triggers<a class="headerlink" href="#rule-triggers" title="Permalink to this heading"></a></h3>
<p>The Trigger control allows selecting when the action should be triggered.</p>
<p>If <strong>Completed Series</strong> is selected, mercure executes the action when a DICOM series has been received for which the rule evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>. If multiple series from a patient study are received, these series are evaluated separately, and may trigger the same, different, or no rules.</p>
<p>If <strong>Completed Study</strong> is selected, all series for a given study are evaluated together. For example, an AI-based analysis algorithm might require multiple series with different contrast. On selection, an additional control <strong>Completion Criteria</strong> will appear, which allows selecting when the study should considered complete. Rules with this trigger are only evaluated when the study appears to be complete, and all the series will be routed or processed together.</p>
<a class="border reference internal image-reference" href="../_images/edit_trigger.png"><img alt="../_images/edit_trigger.png" class="border align-center" src="../_images/edit_trigger.png" style="width: 550px;" /></a>
<p>If <strong>List Series Received</strong> is selected, Mercure evaluates whether the study is complete based on whether specific series have been received using the <code class="docutils literal notranslate"><span class="pre">SeriesDescription</span></code> dicom tag. Here is an example expression that will consider the study complete if it receives a series with a <code class="docutils literal notranslate"><span class="pre">SeriesDescription</span></code> which contains “Axial T2” and another series that has either “SAG T1 GRE” or “Sag T1 TSE”:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;Axial T2&#39; and (&#39;Sag T1 GRE&#39; or &#39;Sag T1 TSE&#39;)
</pre></div>
</div>
<p>This allows handling variability in the Series Descriptions, which often occurs in practice due to inconsistent configuration of imaging devices. Using the control “Action for Incomplete Studies”, it can be defined what should happen if not all of the required series were received (after the configurable timeout has been reached). With “Discard Study”, the incomplete study will be discarded. With “Process Incomplete Study”, the study will be processed with the series that have been received so far. With “Ignore Timeout and Wait”, mercure will continue to wait for arrival of the required series.</p>
<p>If the names of the expected series are unknown, the option “Timeout Reached” can be used instead, which collects image series belonging to the same study until no further series has been received for a definable timeout period (the timeout time can be set on the Configuration page). A disadvantage of this option is that the processing will be delayed until the timeout period has expired.</p>
</section>
<section id="priority">
<h3>Priority<a class="headerlink" href="#priority" title="Permalink to this heading"></a></h3>
<p>If the Priority control is set to “Urgent”, corresponding series or studies will be pushed to the front of the processing queue, while the setting “Off-Peak” enforces that the corresponding series will be only processed during off-peak hours. The latter can be helpful, for example, to prevent that computationally demanding research studies could delay clinically-needed cases during normal work hours.</p>
<p>Rules can be temporarily disabled by toggling the “Disable Rule” switch. In this case, the rule appears in grayed-out color in the rule list and it will be ignored during processing. By clicking the “Fallback Rule” switch, the current rule will be applied to all DICOM series for which no other rules have triggered. This allows defining a “default” rule.</p>
</section>
</section>
<section id="processing-tab">
<h2>Processing tab<a class="headerlink" href="#processing-tab" title="Permalink to this heading"></a></h2>
<p>For rules involving processing, the “Processing” tab can be used to select one or multiple processing modules. To add a module, select it in the dropdown box and press the “+” button to add it to the end of the module list. Each module will be executed in order, left to right. Generally, the output of each module will be used as the input for the next.</p>
<p>The “Settings” input provides rule-specific module settings. These settings will be merged with the global module settings and will overwrite global settings if the same keys occur in both. The settings have to be specified in JSON format. It depends on the individual module which settings are available. This information should be looked up from the module documentation.</p>
<p>If you are using multiple chained modules, this will be used for each of the modules.</p>
<a class="border reference internal image-reference" href="../_images/edit_processing.png"><img alt="../_images/edit_processing.png" class="border align-center" src="../_images/edit_processing.png" style="width: 550px;" /></a>
<p>When selecting the “Retain input images” switch, the module chain will output both the processed images as well as the unprocessed input images. It depends on the individual application if this option is desired or not.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The “Retain input images” option must not be used with modules that should remove confidential information from the data, such as DICOM anonymization modules.</p>
</div>
</section>
<section id="routing-tab">
<h2>Routing tab<a class="headerlink" href="#routing-tab" title="Permalink to this heading"></a></h2>
<p>For rules with dispatching, the “Routing” tab can be used to select the target(s) to which the DICOMs should be dispatched after finishing any processing modules.</p>
<a class="border reference internal image-reference" href="../_images/edit_routing.png"><img alt="../_images/edit_routing.png" class="border align-center" src="../_images/edit_routing.png" style="width: 550px;" /></a>
</section>
<section id="notification-tab">
<h2>Notification tab<a class="headerlink" href="#notification-tab" title="Permalink to this heading"></a></h2>
<p>The “Notification” tab allows configuring webhook calls and emails that can be triggered at various points after a study has been received.</p>
<p>Webhook calls can be used to send notification messages into Slack, WebEx, Teams, or comparable messaging services. They can also be used for connecting other external services, for example, changing the color of a physical status light.</p>
<a class="border reference internal image-reference" href="../_images/edit_notification.png"><img alt="../_images/edit_notification.png" class="border align-center" src="../_images/edit_notification.png" style="width: 550px;" /></a>
<p>The “Webhook Body” input is free text, which can be used eg to specify the contents of a Slack message. It supports the jinja2 template format.</p>
<p>The URL and payload for the webhook call need to be provided. Payload templates for Slack and WebEx can be inserted by pressing the button “Insert Template”. To obtain the webhook URL, you need to go into the configuration of your messaging service (e.g., Slack) and follow the instruction for setting up an incoming webhook. You can use <code class="docutils literal notranslate"><span class="pre">&quot;{{</span> <span class="pre">body</span> <span class="pre">}}&quot;</span></code> to interpolate the “webhook body” as an escaped string.</p>
<p>You can enable PHI inside notifications by setting <code class="docutils literal notranslate"><span class="pre">&quot;phi_notifications&quot;:</span> <span class="pre">True</span></code> in the configuration, which will make it available as <code class="docutils literal notranslate"><span class="pre">phi_data.acc</span></code>, <code class="docutils literal notranslate"><span class="pre">phi_data.mrn</span></code> and <code class="docutils literal notranslate"><span class="pre">phi_data.patient_name</span></code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Be careful sending any sensitive information in the payload because the webhook call will, in most cases, be sent to an externally operated service.</p>
</div>
<p>The “Email Body” works much the same way as the “Webhook Body”. Select “HTML Content” if it should be sent as an HTML email, or leave it unselected to send it as plain-text email.</p>
<p>If either the email address or webhook url is blank, notifications will not be sent via that modality.</p>
</section>
<section id="information-tab">
<h2>Information tab<a class="headerlink" href="#information-tab" title="Permalink to this heading"></a></h2>
<p>The “Information” tab can be used to document the rule. The purpose of the rule can be written as free-text into the Comment field, and an email address can be written into the Contact field, so that it can be looked up at a later time why the rule was defined and who requested it. It is also possible to add tag attributes to the rule. These tags are not yet used for anything else, but might be used in future versions of mercure for filtering purpose and access control.</p>
<a class="border reference internal image-reference" href="../_images/edit_information.png"><img alt="../_images/edit_information.png" class="border align-center" src="../_images/edit_information.png" style="width: 550px;" /></a>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modules.html" class="btn btn-neutral float-left" title="Modules" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="queue.html" class="btn btn-neutral float-right" title="Queue Management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2024 The &#34;mercure&#34; authors and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions">
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>