<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Topics &mdash; mercure Version 0.2.0-beta.7 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Monitoring" href="monitoring.html" />
    <link rel="prev" title="Usage" href="usage.html" />
<script>
    ((window.gitter = {}).chat = {}).options = {
      room: 'mercure-imaging/Support'
    };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/mercure_logo_w.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                Version 0.2.0-beta.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/mercure-imaging/mercure">github.com/mercure-imaging/mercure</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">What is mercure?</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration-files">Configuration files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#additional-settings">Additional settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scaling-services">Scaling services</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboards.html">Dashboard Gallery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Module Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_list.html">Existing Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="anonymizer.html">Anonymizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="dcmannotate.html">DCMAnnotate</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="support.html">Discussion Board</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="environment.html">Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="code.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">mercure</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Advanced Topics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-topics">
<h1>Advanced Topics<a class="headerlink" href="#advanced-topics" title="Permalink to this headline"></a></h1>
<section id="configuration-files">
<h2>Configuration files<a class="headerlink" href="#configuration-files" title="Permalink to this headline"></a></h2>
<p>mercure stores the configuration in multiple files in the subfolder <strong>/opt/mercure/config</strong>. If you want to backup the configuration or install mercure on another machine, you need to copy all files inside this folder. During installation of mercure, these files are generated from template files contained in the folder <strong>/opt/mercure/app/configuration</strong>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 84%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>bookkeeper.env</p></td>
<td><p>Contains IP, port, and DB password for the bookkeeper service</p></td>
</tr>
<tr class="row-odd"><td><p>mercure.json</p></td>
<td><p>Configured rules, targets, modules, and other mercure settings</p></td>
</tr>
<tr class="row-even"><td><p>services.json</p></td>
<td><p>List of configured mercure services (must be modified for scaling services)</p></td>
</tr>
<tr class="row-odd"><td><p>users.json</p></td>
<td><p>User account information for the web interface</p></td>
</tr>
<tr class="row-even"><td><p>webgui.env</p></td>
<td><p>Contains IP, port, and secret key for the web interface</p></td>
</tr>
</tbody>
</table>
</section>
<section id="additional-settings">
<h2>Additional settings<a class="headerlink" href="#additional-settings" title="Permalink to this headline"></a></h2>
<p>Advanced settings can be reviewed and adjusted on the Configuration page of the web interface. To change the settings, click the “Edit Settings” button at the bottom of the page. Once saved, the different service modules will automatically load the updated configuration.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure to preserve correct JSON formatting of the settings. The web interface will automatically check the syntax before saving the file.</p>
</div>
<p>Alternatively to using the web interface, the changes can also be made by directly editing the file <strong>mercure.json</strong> with a Linux text editor, e.g. nano.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>When editing the configuration file directly, it is required to shutdown all mercure services prior to making any changes (via the web interface or systemctl command).</p>
</div>
<p>The following settings can be customized (default values can be found in default_mercure.json):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>appliance_name</p></td>
<td><p>Optional name of the mercure server (useful for multiple servers)</p></td>
</tr>
<tr class="row-odd"><td><p>port</p></td>
<td><p>Port for receiving DICOMs (default: 11112). Must be &gt;1024 for non-root service user.</p></td>
</tr>
<tr class="row-even"><td><p>accept_compressed_images</p></td>
<td><p>Enable reception of compressed DICOMs. Use with care (see below). Requires that all processing modules can handle compressed images.</p></td>
</tr>
<tr class="row-odd"><td><p>incoming_folder</p></td>
<td><p>Buffer location for received DICOM files</p></td>
</tr>
<tr class="row-even"><td><p>studies_folder</p></td>
<td><p>Buffer location for collecting series belonging to one study</p></td>
</tr>
<tr class="row-odd"><td><p>outgoing_folder</p></td>
<td><p>Buffer location for series to be dispatched</p></td>
</tr>
<tr class="row-even"><td><p>success_folder</p></td>
<td><p>Storage location for completed series until retention period has passed</p></td>
</tr>
<tr class="row-odd"><td><p>error_folder</p></td>
<td><p>Storage location for files that could not be parsed or dispatched</p></td>
</tr>
<tr class="row-even"><td><p>discard_folder</p></td>
<td><p>Storage location for discarded series until retention period has passed</p></td>
</tr>
<tr class="row-odd"><td><p>processing_folder</p></td>
<td><p>Buffer location for series to be processed</p></td>
</tr>
<tr class="row-even"><td><p>bookkeeper</p></td>
<td><p>IP and port of the bookkeeper instance</p></td>
</tr>
<tr class="row-odd"><td><p>graphite_ip</p></td>
<td><p>IP address of the graphite server. Leave empty if none</p></td>
</tr>
<tr class="row-even"><td><p>graphite_port</p></td>
<td><p>Port of the graphite server</p></td>
</tr>
<tr class="row-odd"><td><p>router_scan_interval</p></td>
<td><p>Interval how often the router checks for arrived images (sec)</p></td>
</tr>
<tr class="row-even"><td><p>series_complete_trigger</p></td>
<td><p>Time after arrival of last slice when series is considered complete (sec)</p></td>
</tr>
<tr class="row-odd"><td><p>study_complete_trigger</p></td>
<td><p>Time after arrival of last series when study is considered complete (sec)</p></td>
</tr>
<tr class="row-even"><td><p>study_forcecomplete_trigger</p></td>
<td><p>Time after which studies are considered complete even if series are missing (sec)</p></td>
</tr>
<tr class="row-odd"><td><p>dispatcher_scan_interval</p></td>
<td><p>Interval how often the dispatcher checks for series to be sent (sec)</p></td>
</tr>
<tr class="row-even"><td><p>retry_delay</p></td>
<td><p>Delay before retrying to dispatch series after failure (sec)</p></td>
</tr>
<tr class="row-odd"><td><p>retry_max</p></td>
<td><p>Maximum number of retries when dispatching</p></td>
</tr>
<tr class="row-even"><td><p>cleaner_scan_interval</p></td>
<td><p>Interval how often the cleaner checks for files to be deleted (sec)</p></td>
</tr>
<tr class="row-odd"><td><p>retention</p></td>
<td><p>Duration how long files will be kept before deletion (sec)</p></td>
</tr>
<tr class="row-even"><td><p>offpeak_start</p></td>
<td><p>Start of the off-peak work hours (24h format)</p></td>
</tr>
<tr class="row-odd"><td><p>offpeak_end</p></td>
<td><p>End of the off-peak work hours (24h format)</p></td>
</tr>
<tr class="row-even"><td><p>targets</p></td>
<td><p>Configured targets - should be edited via web interface</p></td>
</tr>
<tr class="row-odd"><td><p>rules</p></td>
<td><p>Configured rules - should be edited via web interface</p></td>
</tr>
<tr class="row-even"><td><p>modules</p></td>
<td><p>Configured modules - should be edited via web interface</p></td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>By default, the mercure DICOM receiver requests incoming DICOM images in uncompressed format. Thus, compressed images need to be decompressed by the sender prior to the transfer (e.g., if sending cases from a PACS that stores images in compressed form). This avoids potential incompatibilities between different implementations of the compression algorithms and ensures best compatibility. If using mercure solely for routing purpose, it can be more efficient to accept images also in compressed form. This can be enabled by setting accept_compressed_images to “True”. However, this setting requires that all processing modules that are installed on the mercure server need to be able to handle compressed images (this might not be the case for many modules, including the demo modules). Also, if accepting compressed images, it can happen that the images will still be decompressed during dispatching if the target DICOM node indicates preference for uncompressed images.</p>
</div>
</section>
<section id="scaling-services">
<h2>Scaling services<a class="headerlink" href="#scaling-services" title="Permalink to this headline"></a></h2>
<p>By default, mercure uses only a single instance of each service module (i.e., in the case of the dispatcher, only one series per time is sent outwards). This provides sufficient performance for most applications. However, for demanding applications with very high volume of incoming DICOM series, it can be necessary run multiple instances of the modules (router, processor, dispatcher). All mercure modules have been written to allow for parallel execution, so that additional instances can be started.</p>
<p>The exact procedure for scaling up services depends on the type of mercure installation (systemd / Docker / Nomad). The instructions below describe how services can be duplicated when using systemd (which is preferred for high-performance installations).</p>
<p>For systemd installations, the file <strong>services.json</strong> in the folder <strong>/opt/mercure/config</strong> needs to be modified. Here, the section of each module that should be scaled needs to be duplicated. For example, for scaling the dispatcher, the “dispatcher” section needs to be duplicated and a unique name needs to be selected for the copy (for the section name and inner keys “name” and “systemd_service”, as shown below):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="o">...</span>
    <span class="s2">&quot;dispatcher&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dispatcher&quot;</span><span class="p">,</span>
        <span class="s2">&quot;systemd_service&quot;</span><span class="p">:</span> <span class="s2">&quot;mercure_dispatcher.service&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docker_service&quot;</span><span class="p">:</span> <span class="s2">&quot;mercure_dispatcher_1&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;dispatcher2&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dispatcher2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;systemd_service&quot;</span><span class="p">:</span> <span class="s2">&quot;mercure_dispatcher2.service&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docker_service&quot;</span><span class="p">:</span> <span class="s2">&quot;mercure_dispatcher_2&quot;</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is not necessary to scale the receiver module, as the receiver automatically launches a separate process for every DICOM connection.</p>
</div>
<p>Afterwards, the .service files of the scaled service modules need to be duplicated in the folder <strong>/etc/systemd/system</strong>. For example, if duplicating the dispatcher module as shown above, copy the existing file mercure_dispatcher.service and name it mercure_dispatcher2.service (or whatever has been listed in the file services.json). Enable and start the duplicated service by calling (from an account with sudo rights):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">mercure_dispatcher2</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">mercure_dispatcher2</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>As last step, it is necessary to authorize the mercure system user to control the duplicated services. This is done by editing the file <strong>/etc/sudoers.d/mercure</strong> (using a user account with sudo permission) and adding a line for each duplicated service (according to the name specified above). When copying an existing line from the file, make sure to change every occurrence of the service name in the line.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="usage.html" class="btn btn-neutral float-left" title="Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="monitoring.html" class="btn btn-neutral float-right" title="Monitoring" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022, Kai Tobias Block, Roy Wiggins, Joshy Cyriac.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EHLH5W4KQW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-EHLH5W4KQW', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>